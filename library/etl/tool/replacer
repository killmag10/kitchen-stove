#!/bin/bash

##
# Replace variables in a file.
#
# $1    string      template file to read
# $*    string      configuration files to read

templateFile="$1"
shift
if [ ! -e "$templateFile" ]; then
        printf 'Template file "%s" not found!\n' "$templateFile"
        exit 1;
fi

configFiles=( "$@" )
for file in "${configFiles[@]}"; do
    if [ ! -e "$file" ]; then
        printf 'Configuration file "%s" not found!\n' "$file"
        exit 1;
    fi
done

contentConfig="`cat "${configFiles[@]}" | grep -v '^[[:space:]]*#' | grep -v '^[[:space:]]*$'`"
contentTemplate="`cat "$templateFile"`"
contentOutput="$contentTemplate"
configParseRegex='s/[[:space:]]*$//;s/^\([a-zA-Z][a-zA-Z0-9_.]*\)[[:space:]]*=[[:space:]]*\(.*\)/%s/'
configParseRegexKey="`printf "$configParseRegex" "\1"`"
configParseRegexValue="`printf "$configParseRegex" "\2"`"

IFS=$'\n';
for configLine in $contentConfig; do
    configKey="`printf '%s' "$configLine" | sed "$configParseRegexKey"`"
    configValue="`printf '%s' "$configLine" | sed "$configParseRegexValue"`"
    [ -z "$configKey" ] && continue
    configKey='${'"$configKey"'}';
    contentOutput="${contentOutput//${configKey}/${configValue}}"
done

printf '%s\n' "$contentOutput"
